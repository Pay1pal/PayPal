<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Geld senden</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fff;
      height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }
    .top-bar { padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    .profile-section { text-align: center; margin-top: 10px; }
    .profile-circle { 
      width: 60px; 
      height: 60px; 
      background: #333; 
      color: white; 
      border-radius: 50%; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      font-size: 20px; 
      margin: 0 auto; 
      overflow: hidden; 
    }
    .profile-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .username { margin-top: 8px; font-weight: bold; }
    .amount-display { font-size: 42px; text-align: center; margin: 20px 0; cursor: pointer; }
    .currency-select { text-align: center; }
    .currency-select button { padding: 8px 15px; border-radius: 25px; border: 1px solid #ccc; font-size: 14px; cursor: pointer; }
    .message-input { text-align: center; margin-top: 15px; }
    .message-input input { width: 90%; padding: 12px; border: none; background: #f0f0f0; border-radius: 25px; font-size: 16px; text-align: center; }
    .actions { display: flex; justify-content: space-around; margin: 20px 0; }
    .actions button { flex: 1; margin: 0 10px; padding: 14px 0; border: none; background: #000; color: #fff; font-size: 16px; border-radius: 30px; font-weight: bold; }
    .keypad { position: fixed; bottom: 0; left: 0; width: 100%; background: #eee; padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; transform: translateY(100%); transition: transform 0.4s ease-in-out; z-index: 999; }
    .keypad.show { transform: translateY(0%); }
    .keypad button { padding: 20px; font-size: 20px; background: white; border: none; border-radius: 10px; font-weight: bold; color: black; }
    .keypad button:active { background: #ddd; }
  </style>
</head>
<body>

<div class="top-bar">Geld senden</div>

<div class="profile-section">
  <div class="profile-circle" id="avatar"></div>
  <div class="username" id="username">Max Mustermann</div>
</div>

<div class="amount-display" id="amountDisplay">£0.00</div>

<div class="currency-select">
  <button>EUR '</button>
</div>

<div class="message-input">
  <input type="text" placeholder="Wofür ist das?" />
</div>

<div class="actions">
  <button onclick="window.location.href='error.html'">Anfordern</button>
  <button id="payButton" onclick="pay()">Bezahlen</button>
</div>

<div class="keypad" id="keypad">
  <button onclick="appendNumber('1')">1</button>
  <button onclick="appendNumber('2')">2</button>
  <button onclick="appendNumber('3')">3</button>
  <button onclick="appendNumber('4')">4</button>
  <button onclick="appendNumber('5')">5</button>
  <button onclick="appendNumber('6')">6</button>
  <button onclick="appendNumber('7')">7</button>
  <button onclick="appendNumber('8')">8</button>
  <button onclick="appendNumber('9')">9</button>
  <button onclick="clearAmount()">C</button>
  <button onclick="appendNumber('0')">0</button>
  <button onclick="backspace()">←</button>
</div>

<script>
  const amountDisplay = document.getElementById("amountDisplay");
  const keypad = document.getElementById("keypad");
  const payButton = document.getElementById("payButton");
  let rawAmount = "";
  let hideTimeout;

  payButton.disabled = true;
  payButton.style.opacity = "0.5";

  amountDisplay.addEventListener("click", () => {
    keypad.classList.add("show");
    resetHideTimeout();
  });

  function formatAmount(amount) {
    let num = parseInt(amount || "0");
    return "£" + num.toLocaleString() + ".00";
  }

  function updatePayButton() {
    if (rawAmount.length === 0) {
      payButton.disabled = true;
      payButton.style.opacity = "0.5";
    } else {
      payButton.disabled = false;
      payButton.style.opacity = "1";
    }
  }

  function resetHideTimeout() {
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      keypad.classList.remove("show");
    }, 2000);
  }

  function appendNumber(num) {
    rawAmount += num;
    amountDisplay.textContent = formatAmount(rawAmount);
    updatePayButton();
    resetHideTimeout();
  }

  function clearAmount() {
    rawAmount = "";
    amountDisplay.textContent = "£0.00";
    updatePayButton();
    resetHideTimeout();
  }

  function backspace() {
    rawAmount = rawAmount.slice(0, -1);
    amountDisplay.textContent = formatAmount(rawAmount);
    updatePayButton();
    resetHideTimeout();
  }

  function pay() {
    if (rawAmount.length > 0) {
      localStorage.setItem("sentAmount", rawAmount);
      window.location.href = 'load.html?redirect=next.html';
    }
  }

  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    let now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDPWgVdVTjD_m4BKslwSceTcWuFcNfqU1w",
    authDomain: "fir-7083c.firebaseapp.com",
    projectId: "fir-7083c",
    storageBucket: "fir-7083c.appspot.com",
    messagingSenderId: "281874138708",
    appId: "1:281874138708:web:a593d260193ad9192acfc1",
    measurementId: "G-0FPM8HG3RR"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const avatar = document.getElementById("avatar");
  const username = document.getElementById("username");

  const storedName = localStorage.getItem("receiver_name") || "Max Mustermann";
  username.textContent = storedName;

  db.collection("user_photos").doc("globalProfile").get()
    .then(doc => {
      if (doc.exists && doc.data().image) {
        avatar.innerHTML = '<img src="' + doc.data().image + '" />';
      }
    })
    .catch(err => {
      console.error(err);
    });
</script>

</body>
</html>
